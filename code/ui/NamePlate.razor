@using Sandbox;
@using Sandbox.UI;
@using System;

@namespace Spleef
@inherits WorldPanel
@attribute [StyleSheet]

<root>
	<div class="Background">
		<img class="SteamAvatar" src="avatar:@client.SteamId" />
		<p class="Text">@client.Name</p>
		@if (client.Voice.LastHeard < 2)
		{
			<img class="SpeakerIcon" src="https://cdn-icons-png.flaticon.com/512/2/2384.png" />
		}
	</div>
</root>

@code
{
	public IClient client { get; private set; }
	public NamePlate(IClient Client)
	{
		client = Client;
	}
	protected override int BuildHash()
	{
		if (client == null || !IsDeleting)
			return base.BuildHash();

		if (!(client.IsValid || client.Pawn.IsValid))
			return base.BuildHash();

		//return base.BuildHash()
		return HashCode.Combine(client?.Pawn, client?.Voice.LastHeard);
	}

	public override void OnDeleted()
	{
		base.OnDeleted();
		Log.Warning("OnDelete called....");
		client = null;
	}

	public override void Tick()
	{
		if (IsDeleting || client == null)
		{
			Log.Warning("Tick on deleted object called");
			return;
		}

		base.Tick();
		WorldScale = 1f;

		if (Camera.Main == null)
			Log.Error("Invalid Camera?");


		if (!client.IsValid)
		{
			return;
		}
		if (!client.Pawn.IsValid)

		{
			Log.Error("PAWN IS NOT VALID");
			return;
		}

		if (!(client.Pawn is NamePlatePosition))
		{
			//TODO allow this to be a component attached to the player
			Log.Error("Pawn does not implement 'NamePlatePosition' Interface.....");
			return;
		}

		Vector3 pt = Camera.Position - Position;
		Rotation lookRotation = Rotation.LookAt(pt);

		Rotation = lookRotation;

		Position = client.Pawn.Position + ((NamePlatePosition)client.Pawn).GetNamePlateLocalOffset();
	}
}